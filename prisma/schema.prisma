// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// Al hacer cambios ejecutar:
// npx prisma migrate dev --name nombre_del_cambio
// para migracion y cambio de tipos en TypeScript
generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider         = "zod-prisma-types"
  output           = "../src/generated/zod" 
  useMultipleFiles = true 
  prismaClientImportPath = "@prisma/client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id String @id @default(uuid()) @db.Uuid /// @zod.string.uuid()
  auth0Id String? @unique @map("auth0_id")
  rut String @unique /// @zod.string.trim().toUpperCase().regex(/^\d{7,8}-[\dK]$/, { message: "Formato inválido" })
  names String /// @zod.string.min(2).trim()
  lastName0 String @map("last_name0") /// @zod.string.min(2).trim()
  lastName1 String @map("last_name1") /// @zod.string.min(2).trim()
  email String @unique /// @zod.string.email().toLowerCase()
  createdAt DateTime @default(now()) @map("created_at")
  userRoles UserRole[]
  courseEnrolments CourseEnrolment[]
  sectionEnrolments SectionEnrolment[]
  attendances Attendance[]
  staffProfile StaffProfile?
  studentProfile StudentProfile?
  creationJob CreationJob[]
  creationJobItem CreationJobItem[]
  @@map("users")
}

enum ApplicationState {
  PENDING_AS_STUDENT
  PENDING_AS_STAFF
  ACCEPTED_AS_STUDENT
  ACCEPTED_AS_STAFF
  CREATED
  REJECTED
  ACTIVE
}

model StaffProfile {
  id String @id @default(uuid()) @db.Uuid /// @zod.string.uuid()
  userId String @map("user_id") @db.Uuid @unique
  applicationState ApplicationState @default(PENDING_AS_STAFF) @map("application_state")

  user User @relation(fields: [userId], references: [id])

  @@map("staff_profiles")
}

model StudentProfile {
  id String @id @default(uuid()) @db.Uuid /// @zod.string.uuid()
  userId String @map("user_id") @db.Uuid @unique /// @zod.string.uuid()
  applicationState ApplicationState @default(PENDING_AS_STUDENT) @map("application_state")

  user User @relation(fields: [userId], references: [id])

  @@map("student_profiles")
}

model Role {
  id String @id @default(uuid()) @db.Uuid /// @zod.string.uuid()
  label String @unique

  userRoles UserRole[]

  courseEnrolments CourseEnrolment[]
  sectionEnrolments SectionEnrolment[]
  
  @@map("roles")
}

model UserRole {
  userId String @map("user_id") @db.Uuid /// @zod.string.uuid()
  roleId String @map("role_id") @db.Uuid /// @zod.string.uuid()

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
  @@map("user_roles")
}

model Course {
  id String @id @default(uuid()) @db.Uuid /// @zod.string.uuid()
  name String

  sections Section[]
  courseEnrolments CourseEnrolment[]

  @@map("courses")
}

model CourseEnrolment {
  id String @id @default(uuid()) @db.Uuid /// @zod.string.uuid()
  userId String @map("user_id") @db.Uuid /// @zod.string.uuid()
  roleId String @map("role_id") @db.Uuid /// @zod.string.uuid()
  courseId String @map("course_id") @db.Uuid /// @zod.string.uuid()

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])
  course Course @relation(fields: [courseId], references: [id])

  @@map("course_enrolments")
}

model Section {
  id String @id @default(uuid()) @db.Uuid /// @zod.string.uuid()
  courseId String @map("course_id") @db.Uuid /// @zod.string.uuid()

  course Course @relation(fields: [courseId], references: [id])
  sectionEnrolments SectionEnrolment[]
  schedules Schedule[]
  events Event[]

  @@map("sections")
}

model SectionEnrolment {
  id String @id @default(uuid()) @db.Uuid /// @zod.string.uuid()
  userId String @map("user_id") @db.Uuid /// @zod.string.uuid()
  roleId String @map("role_id") @db.Uuid /// @zod.string.uuid()
  sectionId String @map("section_id") @db.Uuid /// @zod.string.uuid()

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])
  section Section @relation(fields: [sectionId], references: [id])

  @@map("section_enrolments")
}

model Schedule {
  id String @id @default(uuid()) @db.Uuid /// @zod.string.uuid()
  sectionId String @map("section_id") @db.Uuid /// @zod.string.uuid()
  day Int /// @zod.number.int().min(0).max(6, { message: "Día debe ser entre 0 y 6" })
  // Minutos desde la medianoche:
  startTime Int @map("start_time") /// @zod.number.int().min(0).max(1439)
  endTime Int @map("end_time") /// @zod.number.int().min(0).max(1439)

  section Section @relation(fields: [sectionId], references: [id])

  @@map("schedules")
}

model Event {
  id String @id @default(uuid()) @db.Uuid /// @zod.string.uuid()
  sectionId String @map("section_id") @db.Uuid /// @zod.string.uuid()
  startDateTime DateTime @map("start_date_time")
  endDateTime DateTime @map("end_date_time")

  section Section @relation(fields: [sectionId], references: [id])
  attendances Attendance[]

  @@map("events")
}

model Attendance {
  id String @id @default(uuid()) @db.Uuid /// @zod.string.uuid()
  userId String @map("user_id") @db.Uuid /// @zod.string.uuid()
  eventId String @map("event_id") @db.Uuid /// @zod.string.uuid()

  user User @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id])

  @@unique([userId, eventId])
  @@map("attendances")
}

enum CreationJobTarget {
  STUDENTS
  STAFF
}

enum CreationJobStatus {
  PENDING
  RUNNING
  DONE
  DONE_WITH_ERRORS
}

model CreationJob {
  id String @id @default(uuid()) @db.Uuid /// @zod.string.uuid()
  creatorId String @map("creator_id") @db.Uuid /// @zod.string.uuid()
  target CreationJobTarget
  status CreationJobStatus
  createdAt DateTime @default(now())

  creator User @relation(fields: [creatorId], references: [id])
  item CreationJobItem[]

  @@map("creation_jobs")
}

model CreationJobItem {
  id String @id @default(uuid()) @db.Uuid
  jobId String @map("job_id") @db.Uuid
  userId String @map("user_id") @db.Uuid
  status CreationJobStatus
  target CreationJobTarget
  error String?

  job CreationJob @relation(fields: [jobId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([jobId, userId, target])
  @@map("creation_job_items")
}